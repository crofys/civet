<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title></title>
    <style>
        ._cv_waterfall {
            /* display: inline-block; */
            position: absolute;
        }
    </style>
</head>
<body>
    <div id="main-content">
        <div class="el-scrollbar" style="height: 96vh;">
            <div class="el-scrollbar__wrap" style="overflow-x: hidden; margin-bottom: -17px; margin-right: -17px;">
                <div class="el-scrollbar__view">
                    <div id="items" style="overflow: hidden;">
                    </div>
                </div>
            </div>
            <div class="el-scrollbar__bar is-vertical">
                <div class="el-scrollbar__thumb" style="transform: translateY(0%);"></div>
            </div>
        </div>
    </div>
    <script>
        const Layout = (function(rootID){
            const minGap = 5;  // px
            const MIN_WIDTH = 200;   //px
            const TITLE_HEIGHT = 21.5;    //px
            const TITLE_GAP = 2;
            let HORIZON_COUNT = 4;
            let curWidth = 0;
            let minCol = 0;
            let minVertical = [];
            for (let idx = 0; idx < HORIZON_COUNT; ++idx) {
                minVertical.push(Infinity)
            }
            function getMinColumn(index, height) {
                const result = minVertical.reduce((left, right, index, arr) => {
                    if (right < left.val) {
                        left.val = right
                        left.index = index
                    }
                    return left
                }, {val: minVertical[0], index: 0})
                return result.index
            }
            function updateMinColumn(index, height) {
                minVertical[index] += height
                minCol = getMinColumn(index, height)
            }
            function getItemWidth() {
                const root = document.getElementById(rootID)
                console.info('root.offsetWidth', root.offsetWidth)
                return root.offsetWidth / HORIZON_COUNT
            }
            function generateFromTemplate(item) {
                let div = document.createElement('div')
                div.setAttribute('class', '_cv_waterfall')
                div.style.left = `${item.left}px`
                div.style.top = `${item.top}px`
                div.style.width = `${item.width}px`
                div.style.height = `${item.height}px`
                div.innerHTML = `<div draggable="true" class="image">
                                    <div class="el-card is-never-shadow" style="border: 0px;">
                                        <div class="el-card__body" style="padding: 1px;">
                                            <div class="frame"><img src="${item.thumbnail?item.thumbnail:item.src}" width="100%" class="mini-cover"></div>
                                            <div style="padding: 2px; text-overflow: ellipsis; white-space: nowrap; overflow: hidden; text-align: center; font-size: 12px;">
                                                <span class="context">${item.name}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>`
                return div
            }
            function update(items) {

            }
            function addElement(item) {
                const items = document.querySelectorAll('._cv_waterfall')
                const root = document.getElementById(rootID)
                const height = parseInt(item['height']) + TITLE_HEIGHT + 2 * TITLE_GAP
                console.info('addElement', height, items.length, minVertical[items.length] > height)
                if (items.length < HORIZON_COUNT) {
                    item['left'] = items.length * curWidth
                    item['top'] = 0
                    if (minVertical[items.length] > height) {
                        minVertical[items.length] = height
                    }
                    minCol = getMinColumn(items.length, height)
                    root.appendChild(generateFromTemplate(item))
                    return
                }
                item['left'] = minCol * curWidth
                item['top'] = minVertical[minCol]
                root.appendChild(generateFromTemplate(item))
                console.info('grid element', minCol, minVertical, item)
                updateMinColumn(minCol, height)
            }
            return {
                add: function(item) {
                    let block = {}, src
                    // console.info('item', item)
                    for (let meta of item['meta']) {
                        if (meta['name'] === 'filename') block['name'] = meta.value
                        else if (meta['name'] === 'path') src = meta.value
                        else if (meta['name'] === 'thumbnail') block['thumbnail'] = 'data:image/jpg;base64,' + btoa(String.fromCharCode.apply(null, meta.value.data))
                        else if (meta['name'] === 'height') block['height'] = meta.value
                        else if (meta['name'] === 'width') block['width'] = meta.value
                    }
                    if (!src) return ''
                    if (src.indexOf(':') < 0 && src[0] !== '/') return ''
                    block['src'] = 'file://' + src
                    curWidth = getItemWidth()
                    if (curWidth < MIN_WIDTH) {

                    }
                    const scale = parseInt(block['width']) / curWidth
                    // console.info('scale', scale, block)
                    block['height'] = parseInt(block['height']) / scale
                    block['width'] = curWidth
                    addElement(block)
                },
                erase: function(item) {}
            }
        })('items')

        function loadResources(resources) {
            console.info('load:', resources)
            for (let resource of resources) {
                Layout.add(resource)
            }
        }

        loadResources({{resources}})
    </script>
</body>

</html>