<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title></title>
    <style>
        html, body, #container {
            height: 100%;
            width: 100%;
        }

        .amap-icon img {
            width: 25px;
            height: 34px;
        }

        .amap-marker-label{
            border: 0;
            background-color: transparent;
        }

        .info{
            position: relative;
            top: 0;
            right: 0;
            min-width: 0;
        }
        #container {
            height:100%;
        }
    </style>
</head>
<body>
<div id="container"></div>
<script type="text/javascript"
        src="https://webapi.amap.com/maps?v=1.4.15&key=6918ecca2a3cbfafb6ab59369768ae21&plugin=AMap.MarkerClusterer"></script>
<script type="text/javascript">
// var cluster;
MapLayout = (function() {
    let markers = []
    let map = new AMap.Map('container', {
        resizeEnable: true,
        center: [116.397428, 39.90923],
        zoom: 10
    });
    let count = 0;
    const _renderClusterMarker = function (context) {
        if (count === 0) return;
        let factor = Math.pow(context.count / count, 1 / 18);
        let div = document.createElement('div');
        let Hue = 180 - factor * 180;
        let bgColor = 'hsla(' + Hue + ',100%,50%,0.7)';
        let fontColor = 'hsla(' + Hue + ',100%,20%,1)';
        let borderColor = 'hsla(' + Hue + ',100%,40%,1)';
        let shadowColor = 'hsla(' + Hue + ',100%,50%,1)';
        div.style.backgroundColor = bgColor;
        let size = Math.round(30 + Math.pow(context.count / count, 1 / 5) * 20);
        div.style.width = div.style.height = size + 'px';
        div.style.border = 'solid 1px ' + borderColor;
        div.style.borderRadius = size / 2 + 'px';
        div.style.boxShadow = '0 0 1px ' + shadowColor;
        div.innerHTML = context.count;
        div.style.lineHeight = size + 'px';
        div.style.color = fontColor;
        div.style.fontSize = '14px';
        div.style.textAlign = 'center';
        context.marker.setOffset(new AMap.Pixel(-size / 2, -size / 2));
        context.marker.setContent(div)
        console.info('map render', count)
    }
    let cluster
    // let cluster = new AMap.MarkerClusterer(map, markers, {
    //     gridSize: 80,
    //     renderClusterMarker: _renderClusterMarker
    // });
    return {
        add: function(resources) {
            for (var i = 0; i < resources.length; i += 1) {
                markers.push(new AMap.Marker({
                    position: resources[i]['lnglat'],
                    content: `<div style="background-color: hsla(180, 100%, 50%, 0.7); height: 24px; width: 24px; border: 1px solid hsl(180, 100%, 40%); border-radius: 12px; box-shadow: hsl(180, 100%, 50%) 0px 0px 1px;"
                        onclick="Overview.click(${resources[i].id})"></div>`,
                    offset: new AMap.Pixel(-15, -15)
                }))
            }
            count = markers.length
            console.info('add map resource', resources)
            // addCluster(2, map, markers)
            if (cluster) {
                cluster.setMap(null);
            }
            cluster = new AMap.MarkerClusterer(map, markers, {
                gridSize: 80,
                renderClusterMarker: _renderClusterMarker
            });
        }
    }
})()


let points = [{"lnglat":["113.864691","22.942327"], id: 121},{"lnglat":["113.370643","22.938827"], id: 121},{"lnglat":["112.985037","23.15046"], id: 121}]
function loadResources(resources) {
    if (!resources) return
    console.info('loadResources', resources)
    MapLayout.add(points)
}

loadResources({{resources}})

</script>
</body>
</html>